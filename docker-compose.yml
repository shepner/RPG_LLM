services:
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data

  auth:
    build:
      context: .
      dockerfile: ./services/auth/Dockerfile
    ports:
      - "8000:8000"
    environment:
      - DATABASE_URL=sqlite+aiosqlite:///./RPG_LLM_DATA/databases/auth.db
      - JWT_SECRET_KEY=${JWT_SECRET_KEY}
      - JWT_ALGORITHM=${JWT_ALGORITHM:-HS256}
      - JWT_EXPIRATION=${JWT_EXPIRATION:-24h}
    volumes:
      - ./RPG_LLM_DATA:/app/RPG_LLM_DATA

  game_session:
    build:
      context: .
      dockerfile: ./services/game_session/Dockerfile
    ports:
      - "8001:8001"
    environment:
      - DATABASE_URL=sqlite+aiosqlite:///./RPG_LLM_DATA/databases/game_session.db
    volumes:
      - ./RPG_LLM_DATA:/app/RPG_LLM_DATA
    depends_on:
      - redis

  rules_engine:
    build:
      context: .
      dockerfile: ./services/rules_engine/Dockerfile
    ports:
      - "8002:8002"
    volumes:
      - ./RPG_LLM_DATA:/app/RPG_LLM_DATA
      - ./credentials.json:/app/credentials.json:ro
    environment:
      - RULES_DIR=./RPG_LLM_DATA/rules
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - GOOGLE_APPLICATION_CREDENTIALS=${GOOGLE_APPLICATION_CREDENTIALS:-/app/credentials.json}
      - LLM_MODEL=${LLM_MODEL:-gemini-1.0-pro}
      - CHROMA_DB_PATH=./RPG_LLM_DATA/vector_stores/rules

  time_management:
    build:
      context: .
      dockerfile: ./services/time_management/Dockerfile
    ports:
      - "8003:8003"
    environment:
      - DATABASE_URL=sqlite+aiosqlite:///./RPG_LLM_DATA/databases/time_management.db
    volumes:
      - ./RPG_LLM_DATA:/app/RPG_LLM_DATA
    depends_on:
      - redis

  worlds:
    build:
      context: .
      dockerfile: ./services/worlds/Dockerfile
    ports:
      - "8004:8004"
    environment:
      - DATABASE_URL=sqlite+aiosqlite:///./RPG_LLM_DATA/databases/worlds.db
      - CHROMA_DB_PATH=./RPG_LLM_DATA/vector_stores/worlds
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - GOOGLE_APPLICATION_CREDENTIALS=${GOOGLE_APPLICATION_CREDENTIALS:-/app/credentials.json}
    volumes:
      - ./RPG_LLM_DATA:/app/RPG_LLM_DATA
      - ./credentials.json:/app/credentials.json:ro
    depends_on:
      - redis

  game_master:
    build:
      context: .
      dockerfile: ./services/game_master/Dockerfile
    ports:
      - "8005:8005"
    environment:
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - GOOGLE_APPLICATION_CREDENTIALS=${GOOGLE_APPLICATION_CREDENTIALS:-/app/credentials.json}
      - LLM_MODEL=${LLM_MODEL:-gemini-1.0-pro}
      - REDIS_URL=redis://redis:6379
    volumes:
      - ./RPG_LLM_DATA:/app/RPG_LLM_DATA
      - ./credentials.json:/app/credentials.json:ro
    depends_on:
      - redis

  being:
    build:
      context: .
      dockerfile: ./services/being/Dockerfile
    ports:
      - "8006:8006"
    environment:
      - DATABASE_URL=sqlite+aiosqlite:///./RPG_LLM_DATA/databases/being.db
      - CHROMA_DB_PATH=./RPG_LLM_DATA/vector_stores/beings
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - GOOGLE_APPLICATION_CREDENTIALS=${GOOGLE_APPLICATION_CREDENTIALS:-/app/credentials.json}
      - REDIS_URL=redis://redis:6379
    volumes:
      - ./RPG_LLM_DATA:/app/RPG_LLM_DATA
      - ./credentials.json:/app/credentials.json:ro
    depends_on:
      - redis

  being_registry:
    build:
      context: .
      dockerfile: ./services/being_registry/Dockerfile
    ports:
      - "8007:8007"
    environment:
      - DATABASE_URL=sqlite+aiosqlite:///./RPG_LLM_DATA/databases/auth.db
      - JWT_SECRET_KEY=${JWT_SECRET_KEY:-change-me-in-production}
      - JWT_ALGORITHM=${JWT_ALGORITHM:-HS256}
      - JWT_EXPIRATION=${JWT_EXPIRATION:-24}
      - RULES_ENGINE_URL=http://rules_engine:8002
      - AUTH_URL=http://auth:8000
      - GAME_SESSION_URL=http://game_session:8003
      - WORLDS_URL=http://worlds:8004
      - GAME_MASTER_URL=http://game_master:8005
      - TIME_MANAGEMENT_URL=http://time_management:8006
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./RPG_LLM_DATA:/app/RPG_LLM_DATA
    depends_on:
      - being
      - rules_engine

  web_interface:
    build:
      context: .
      dockerfile: ./services/web_interface/Dockerfile
    ports:
      - "8081:80"
    depends_on:
      - auth
      - worlds
      - game_master

volumes:
  redis_data:

