services:
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data

  auth:
    build:
      context: .
      dockerfile: ./services/auth/Dockerfile
    ports:
      - "8000:8000"
    environment:
      - DATABASE_URL=sqlite+aiosqlite:///./RPG_LLM_DATA/databases/auth.db
      - JWT_SECRET_KEY=${JWT_SECRET_KEY}
      - JWT_ALGORITHM=${JWT_ALGORITHM:-HS256}
      - JWT_EXPIRATION=${JWT_EXPIRATION:-24h}
    volumes:
      - ./RPG_LLM_DATA:/app/RPG_LLM_DATA

  game_session:
    build:
      context: .
      dockerfile: ./services/game_session/Dockerfile
    ports:
      - "8001:8001"
    environment:
      - DATABASE_URL=sqlite+aiosqlite:///./RPG_LLM_DATA/databases/game_session.db
    volumes:
      - ./RPG_LLM_DATA:/app/RPG_LLM_DATA
    depends_on:
      - redis

  game_master:
    build:
      context: .
      dockerfile: ./services/game_master/Dockerfile
    ports:
      - "8005:8005"
    environment:
      - DATABASE_URL=sqlite+aiosqlite:///./RPG_LLM_DATA/databases/game_master.db
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - GOOGLE_APPLICATION_CREDENTIALS=${GOOGLE_APPLICATION_CREDENTIALS:-/app/credentials.json}
      - LLM_MODEL=${LLM_MODEL:-gemini-2.5-flash}
      - REDIS_URL=redis://redis:6379
    volumes:
      - ./RPG_LLM_DATA:/app/RPG_LLM_DATA
      - ./credentials.json:/app/credentials.json:ro
    depends_on:
      - redis

  rules_engine:
    build:
      context: .
      dockerfile: ./services/rules_engine/Dockerfile
    ports:
      - "8002:8002"
    volumes:
      - ./RPG_LLM_DATA:/app/RPG_LLM_DATA
      - ./credentials.json:/app/credentials.json:ro
    environment:
      - DATABASE_URL=sqlite+aiosqlite:///./RPG_LLM_DATA/databases/rules_engine.db
      - RULES_DIR=./RPG_LLM_DATA/rules
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - GOOGLE_APPLICATION_CREDENTIALS=${GOOGLE_APPLICATION_CREDENTIALS:-/app/credentials.json}
      - LLM_MODEL=${LLM_MODEL:-gemini-2.5-flash}
      - CHROMA_DB_PATH=./RPG_LLM_DATA/vector_stores/rules

  time_management:
    build:
      context: .
      dockerfile: ./services/time_management/Dockerfile
    ports:
      - "8003:8003"
    environment:
      - DATABASE_URL=sqlite+aiosqlite:///./RPG_LLM_DATA/databases/time_management.db
    volumes:
      - ./RPG_LLM_DATA:/app/RPG_LLM_DATA
    depends_on:
      - redis

  worlds:
    build:
      context: .
      dockerfile: ./services/worlds/Dockerfile
    ports:
      - "8004:8004"
    environment:
      - DATABASE_URL=sqlite+aiosqlite:///./RPG_LLM_DATA/databases/worlds.db
      - CHROMA_DB_PATH=./RPG_LLM_DATA/vector_stores/worlds
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - GOOGLE_APPLICATION_CREDENTIALS=${GOOGLE_APPLICATION_CREDENTIALS:-/app/credentials.json}
      - LLM_MODEL=${LLM_MODEL:-gemini-2.5-flash}
    volumes:
      - ./RPG_LLM_DATA:/app/RPG_LLM_DATA
      - ./credentials.json:/app/credentials.json:ro
    depends_on:
      - redis

  being:
    build:
      context: .
      dockerfile: ./services/being/Dockerfile
    ports:
      - "8006:8006"
    environment:
      - DATABASE_URL=sqlite+aiosqlite:///./RPG_LLM_DATA/databases/being.db
      - CHROMA_DB_PATH=./RPG_LLM_DATA/vector_stores/beings
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - GOOGLE_APPLICATION_CREDENTIALS=${GOOGLE_APPLICATION_CREDENTIALS:-/app/credentials.json}
      - LLM_MODEL=${LLM_MODEL:-gemini-2.5-flash}
      - REDIS_URL=redis://redis:6379
    volumes:
      - ./RPG_LLM_DATA:/app/RPG_LLM_DATA
      - ./credentials.json:/app/credentials.json:ro
    depends_on:
      - redis

  being_registry:
    build:
      context: .
      dockerfile: ./services/being_registry/Dockerfile
    ports:
      - "8007:8007"
    environment:
      - DATABASE_URL=sqlite+aiosqlite:///./RPG_LLM_DATA/databases/auth.db
      - JWT_SECRET_KEY=${JWT_SECRET_KEY:-change-me-in-production}
      - JWT_ALGORITHM=${JWT_ALGORITHM:-HS256}
      - JWT_EXPIRATION=${JWT_EXPIRATION:-24}
      - RULES_ENGINE_URL=http://rules_engine:8002
      - AUTH_URL=http://auth:8000
      - GAME_SESSION_URL=http://game_session:8003
      - WORLDS_URL=http://worlds:8004
      - GAME_MASTER_URL=http://game_master:8005
      - TIME_MANAGEMENT_URL=http://time_management:8006
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - LLM_MODEL=${LLM_MODEL:-gemini-2.5-flash}
      - REDIS_URL=redis://redis:6379
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./RPG_LLM_DATA:/app/RPG_LLM_DATA
    depends_on:
      - being
      - rules_engine
      - redis

  # Being instance service (base image for dynamic containers)
  being_instance_base:
    build:
      context: .
      dockerfile: ./services/being_instance/Dockerfile
    image: rpg_llm_being_instance:latest
    # This service is not started by default - containers are created dynamically
    profiles:
      - no-start

  web_interface:
    build:
      context: .
      dockerfile: ./services/web_interface/Dockerfile
    ports:
      - "8081:80"
    depends_on:
      - auth
      - worlds
      - game_master

  mattermost_db:
    image: postgres:15-alpine
    environment:
      POSTGRES_USER: mmuser
      POSTGRES_PASSWORD: ${MATTERMOST_DB_PASSWORD:-mmuser_password}
      POSTGRES_DB: mattermost
    volumes:
      - mattermost_db_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U mmuser"]
      interval: 10s
      timeout: 5s
      retries: 5

  mattermost:
    image: mattermost/mattermost-team-edition:latest
    platform: linux/amd64  # Mattermost server is AMD64-only; Docker will use emulation on ARM64
    ports:
      - "8065:8065"
    environment:
      MM_SQLSETTINGS_DRIVERNAME: postgres
      MM_SQLSETTINGS_DATASOURCE: postgres://mmuser:${MATTERMOST_DB_PASSWORD:-mmuser_password}@mattermost_db:5432/mattermost?sslmode=disable&connect_timeout=10
      MM_SERVICESETTINGS_SITEURL: ${MATTERMOST_SITE_URL:-http://localhost:8065}
      MM_SERVICESETTINGS_LISTENADDRESS: 0.0.0.0:8065
    volumes:
      - mattermost_data:/mattermost/data
      - mattermost_config:/mattermost/config
    depends_on:
      mattermost_db:
        condition: service_healthy

  mattermost_bot:
    build:
      context: .
      dockerfile: ./services/mattermost_bot/Dockerfile
    ports:
      - "8008:8008"
    environment:
      - MATTERMOST_URL=${MATTERMOST_URL:-http://mattermost:8065}
      - MATTERMOST_BOT_TOKEN=${MATTERMOST_BOT_TOKEN}
      - MATTERMOST_BOT_USERNAME=${MATTERMOST_BOT_USERNAME:-rpg-bot}
      - MATTERMOST_SLASH_COMMAND_TOKEN=${MATTERMOST_SLASH_COMMAND_TOKEN}
      - AUTH_URL=http://auth:8000
      - BEING_URL=http://being:8006
      - BEING_REGISTRY_URL=http://being_registry:8007
      - GAME_SESSION_URL=http://game_session:8001
      - GAME_MASTER_URL=http://game_master:8005
      - RULES_ENGINE_URL=http://rules_engine:8002
      - WORLDS_URL=http://worlds:8004
      - TIME_MANAGEMENT_URL=http://time_management:8003
      - JWT_SECRET_KEY=${JWT_SECRET_KEY}
    volumes:
      - ./RPG_LLM_DATA:/app/RPG_LLM_DATA
    depends_on:
      - mattermost
      - auth
      - being
      - being_registry

volumes:
  redis_data:
  mattermost_db_data:
  mattermost_data:
  mattermost_config:

